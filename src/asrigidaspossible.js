var ARAP=function(a,b,c){this.m=a.length,this.G=math.zeros(2*this.m,2*this.m),this.H=math.zeros(2*this.m,2*this.m),this.GpB,this.verts=a,this.tris=b,this.handles=c,this.computeG(),this.computeGpB(),this.precomputeH()};ARAP.prototype.X=function(a,b,c){return math.subset(a,math.index(b,c))},ARAP.prototype.Z=function(a,b,c,d){var e=this.X;a.subset(math.index(b,c),e(a,b,c)+d),b!=c&&a.subset(math.index(c,b),e(a,c,b)+d)},ARAP.prototype.Zs=function(a,b,c,d){var e=this.X;a.subset(math.index(b,c),e(a,b,c)+d)},ARAP.prototype.xind=function(a){return 2*a},ARAP.prototype.yind=function(a){return 2*a+1},ARAP.prototype.computeG=function(){for(var a=this.G,b=this.H,c=this.tris,d=this.verts,e=this.xind,f=this.yind,g=this.X,h=0;h<c.length;h++){var i=[{v0:c[h].a,v1:c[h].b,v2:c[h].c},{v0:c[h].b,v1:c[h].c,v2:c[h].a},{v0:c[h].c,v1:c[h].a,v2:c[h].b}];c[h].sarray=[],c[h].tarray=[];for(var j=0;3>j;j++){var k=i[j].v0,l=i[j].v1,m=i[j].v2,n=d[k],o=d[l],p=d[m],q=o.x-n.x,r=o.y-n.y,s=math.inv([[q,r],[r,-q]]),t=math.matrix([[p.x-n.x],[p.y-n.y]]),u=math.multiply(s,t),v=g(u,0,0),w=g(u,1,0);c[h].sarray[j]=v,c[h].tarray[j]=w,this.Z(a,e(k),e(k),(1-v)*(1-v)),this.Z(a,e(k),e(l),(1-v)*v),this.Z(a,e(k),f(l),(1-v)*w),this.Z(a,e(k),f(k),-(1-v)*w),this.Z(a,e(k),e(m),-(1-v)),this.Z(a,e(l),e(l),v*v),this.Z(a,e(l),f(l),v*w),this.Z(a,e(l),f(k),-v*w),this.Z(a,e(l),e(m),-v),this.Z(a,f(l),f(l),w*w),this.Z(a,f(l),f(k),-w*w),this.Z(a,f(l),e(m),-w),this.Z(a,f(k),f(k),w*w),this.Z(a,f(k),e(m),w),this.Z(a,e(m),e(m),1),this.Z(a,f(k),f(k),(1-v)*(1-v)),this.Z(a,f(k),e(l),-(1-v)*w),this.Z(a,f(k),e(k),(1-v)*w),this.Z(a,f(k),f(l),(1-v)*v),this.Z(a,f(k),f(m),-(1-v)),this.Z(a,e(l),e(l),w*w),this.Z(a,e(l),e(k),-w*w),this.Z(a,e(l),f(l),-w*v),this.Z(a,e(l),f(m),w),this.Z(a,e(k),e(k),w*w),this.Z(a,e(k),f(l),v*w),this.Z(a,e(k),f(m),-w),this.Z(a,f(l),f(l),v*v),this.Z(a,f(l),f(m),-v),this.Z(a,f(m),f(m),1),this.Z(b,e(l),e(l),1),this.Z(b,e(k),e(k),1),this.Z(b,e(l),e(k),-1),this.Z(b,f(l),f(l),1),this.Z(b,f(k),f(k),1),this.Z(b,f(l),f(k),-1)}var v=c[h].sarray[0],w=c[h].tarray[0];c[h].Finv=math.inv(math.matrix([[2+2*(1-v)*(1-v)+2*w*w,0,2*(1-v)*v-2*w*w,2*(1-v)*w+2*v*w],[0,2+2*w*w+2*(1-v)*(1-v),-2*v*w-2*w*(1-v),-2*w*w+2*v*(1-v)],[2*v*(1-v)-2*w*w,-2*v*w-2*w*(1-v),2+2*v*v+2*w*w,0],[2*(1-v)*w+2*v*w,-2*w*w+2*v*(1-v),0,2+2*w*w+2*v*v]]))}},ARAP.prototype.computeGpB=function(){var a=this.G,b=this.m,c=this.handles,d=2*b-2*c,e=math.subset(a,math.index([0,d],[0,d])),f=math.subset(a,math.index([0,d],[d,2*b])),g=math.subset(a,math.index([d,2*b],[0,d])),h=math.add(e,math.transpose(e)),i=math.add(f,math.transpose(g));this.GpB=math.multiply(math.inv(h),i)},ARAP.prototype.distBtw=function(a,b){var c=a.cx||a.x,d=a.cy||a.y,e=b.cx||b.x,f=b.cy||b.y;return math.sqrt((c-e)*(c-e)+(d-f)*(d-f))},ARAP.prototype.precomputeH=function(){var a=this.H,b=this.m,c=2*b-2*this.handles,d=math.subset(a,math.index([0,c],[0,c])),e=math.subset(a,math.index([0,c],[c,2*b])),f=math.subset(a,math.index([c,2*b],[0,c])),g=math.add(d,math.transpose(d)),h=math.inv(g);this.HpINV=h,this.H10=f,this.H01=e},ARAP.prototype.computeNewVerts=function(a){var b=this.handles,c=this.m,d=this.tris,f=(this.G,this.GpB);this.H;for(var h=this.xind,i=this.yind,j=this.X,k=this.distBtw,l=this.verts,m=[],n=0;n<l.length;n++)m[n]={cx:l[n].x,cy:l[n].y};for(var o in a)m[o].cx=a[o].x,m[o].cy=a[o].y;for(var p=math.zeros(2*b,1),n=0;b>n;n++)this.Zs(p,2*n,0,m[c-b+n].cx),this.Zs(p,2*n+1,0,m[c-b+n].cy);for(var q=math.multiply(f,p),n=0;c-b>n;n++)m[n].cx=-j(q,2*n,0),m[n].cy=-j(q,2*n+1,0);for(var r=[],n=0;n<d.length;n++){var s=m[d[n].a],t=m[d[n].b],u=m[d[n].c],v=d[n].sarray[0],w=d[n].tarray[0],x=math.matrix([[-2*s.cx-2*(1-v)*u.cx-2*w*u.cy],[-2*s.cy+2*w*u.cx-2*(1-v)*u.cy],[-2*t.cx-2*v*u.cx+2*w*u.cy],[-2*t.cy-2*w*u.cx-2*v*u.cy]]),y=math.multiply(d[n].Finv,x);r[n]={a:{cx:-j(y,0,0),cy:-j(y,1,0)},b:{cx:-j(y,2,0),cy:-j(y,3,0)},c:{cx:-j(y,0,0)+v*(-j(y,2,0)- -j(y,0,0))+w*(-j(y,3,0)- -j(y,1,0)),cy:-j(y,1,0)+v*(-j(y,3,0)- -j(y,1,0))-w*(-j(y,2,0)- -j(y,0,0))}}}for(var n=0;n<d.length;n++){var z=r[n],A=k(r[n].a,r[n].b)/k(l[d[n].a],l[d[n].b]),B={cx:(z.a.cx+z.b.cx+z.c.cx)/3,cy:(z.a.cy+z.b.cy+z.c.cy)/3};r[n].a.cx=B.cx+(r[n].a.cx-B.cx)/A,r[n].a.cy=B.cy+(r[n].a.cy-B.cy)/A,r[n].b.cx=B.cx+(r[n].b.cx-B.cx)/A,r[n].b.cy=B.cy+(r[n].b.cy-B.cy)/A,r[n].c.cx=B.cx+(r[n].c.cx-B.cx)/A,r[n].c.cy=B.cy+(r[n].c.cy-B.cy)/A}for(var C=math.zeros(1,2*c),n=0;n<d.length;n++)for(var D=[{v0:d[n].a,v1:d[n].b,i:"a",j:"b"},{v0:d[n].b,v1:d[n].c,i:"b",j:"c"},{v0:d[n].c,v1:d[n].a,i:"c",j:"a"}],E=0;3>E;E++){var F=D[E].v0,G=D[E].v1,H=r[n][D[E].i],I=r[n][D[E].j];this.Zs(C,0,h(G),-2*I.cx),this.Zs(C,0,h(G),2*H.cx),this.Zs(C,0,h(F),2*I.cx),this.Zs(C,0,h(F),-2*H.cx),this.Zs(C,0,i(G),-2*I.cy),this.Zs(C,0,i(G),2*H.cy),this.Zs(C,0,i(F),2*I.cy),this.Zs(C,0,i(F),-2*H.cy)}for(var p=math.zeros(2*b,1),n=0;b>n;n++)this.Zs(p,2*n,0,m[c-b+n].cx),this.Zs(p,2*n+1,0,m[c-b+n].cy);for(var b=this.handles,J=2*c-2*b,K=this.HpINV,H=math.subset(C,math.index(0,[0,J])),L=math.add(this.H01,math.transpose(this.H10)),M=math.multiply(L,p),N=math.multiply(K,math.transpose(H)),q=math.add(math.multiply(K,M),N),n=0;c-b>n;n++)m[n].cx=-j(q,2*n,0),m[n].cy=-j(q,2*n+1,0);for(var n=0;n<m.length;n++)l[n].x=m[n].cx,l[n].y=m[n].cy;return m};